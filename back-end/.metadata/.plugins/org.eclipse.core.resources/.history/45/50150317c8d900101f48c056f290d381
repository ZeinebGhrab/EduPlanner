package com.springboot.springboot.service.planning;

import java.time.LocalDate;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.springboot.springboot.dto.formateur.FormateurStatistiquesDTO;
import com.springboot.springboot.repository.planning.SessionFormationRepository;

@Service
public class FormateurService {

    @Autowired
    private SessionRepository sessionRepository;

    /**
     * Récupère les statistiques d'un formateur
     */
    public FormateurStatistiquesDTO getStatistiques(Long formateurId) {
        LocalDate today = LocalDate.now();
        LocalDate dateDebut = today.minusMonths(3); // Étudiants actifs des 3 derniers mois

        Long sessionsAVenir = sessionRepository.countSessionsAVenirByFormateurId(formateurId, today);
        Long sessionsTerminees = sessionRepository.countSessionsTermineesByFormateurId(formateurId, today);
        Long etudiantsActifs = sessionRepository.countEtudiantsActifsByFormateurId(formateurId, dateDebut);

        return new FormateurStatistiquesDTO(
            sessionsAVenir != null ? sessionsAVenir : 0L,
            sessionsTerminees != null ? sessionsTerminees : 0L,
            etudiantsActifs != null ? etudiantsActifs : 0L
        );
    }

    /**
     * Récupère les sessions d'aujourd'hui pour un formateur
     */
    public List<Session> getSessionsAujourdhui(Long formateurId) {
        LocalDate today = LocalDate.now();
        return sessionRepository.findByFormateurIdAndDate(formateurId, today);
    }

    /**
     * Récupère les prochaines sessions d'un formateur (limitées)
     */
    public List<Session> getUpcomingSessions(Long formateurId, int limit) {
        LocalDate today = LocalDate.now();
        List<Session> sessions = sessionRepository.findUpcomingSessionsByFormateurId(formateurId, today);
        
        // Limiter le nombre de résultats
        if (sessions.size() > limit) {
            return sessions.subList(0, limit);
        }
        return sessions;
    }
}
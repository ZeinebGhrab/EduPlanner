package com.springboot.springboot.repository.planning;

import com.springboot.springboot.entity.planning.SessionFormation;
import com.springboot.springboot.model.Session;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.time.LocalDate;
import java.util.List;

@Repository
public interface SessionRepository extends JpaRepository<Session, Long> {
    
    // Sessions par formateur et date
    @Query("SELECT s FROM Session s WHERE s.formateur.id = :formateurId AND s.date = :date ORDER BY s.heureDebut")
    List<SessionFormation> findByFormateurIdAndDate(@Param("formateurId") Long formateurId, @Param("date") LocalDate date);
    
    // Sessions à venir pour un formateur
    @Query("SELECT s FROM Session s WHERE s.formateur.id = :formateurId AND s.date > :today ORDER BY s.date, s.heureDebut")
    List<SessionFormation> findUpcomingSessionsByFormateurId(@Param("formateurId") Long formateurId, @Param("today") LocalDate today);
    
    // Compter sessions à venir
    @Query("SELECT COUNT(s) FROM Session s WHERE s.formateur.id = :formateurId AND s.date >= :today")
    Long countSessionsAVenirByFormateurId(@Param("formateurId") Long formateurId, @Param("today") LocalDate today);
    
    // Compter sessions terminées
    @Query("SELECT COUNT(s) FROM Session s WHERE s.formateur.id = :formateurId AND s.date < :today")
    Long countSessionsTermineesByFormateurId(@Param("formateurId") Long formateurId, @Param("today") LocalDate today);
    
    // Compter étudiants actifs (distincts dans les groupes du formateur)
    @Query("SELECT COUNT(DISTINCT e.id) FROM Session s JOIN s.groupe g JOIN g.etudiants e WHERE s.formateur.id = :formateurId AND s.date >= :dateDebut")
    Long countEtudiantsActifsByFormateurId(@Param("formateurId") Long formateurId, @Param("dateDebut") LocalDate dateDebut);
}